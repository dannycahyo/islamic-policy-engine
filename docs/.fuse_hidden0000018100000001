# Product Requirements Document (PRD)

## Islamic Policy Engine — Proof of Concept

| Field         | Value                              |
| ------------- | ---------------------------------- |
| Document      | PRD-ISL-PE-001                     |
| Version       | 1.0                                |
| Author        | Engineering Team                  |
| Status        | Draft                              |
| Last Updated  | 2026-02-08                         |

---

## 1. Problem Statement

Hijra Bank's backend services (`be-hijra-bank`) currently embed business rules directly in application code. Policy logic — such as transaction limits, financing eligibility checks, and risk flagging — is scattered across service layers, making it difficult to modify rules without code changes, testing cycles, and redeployment.

This creates three core problems:

1. **Slow rule iteration** — changing a transaction limit threshold requires a code change, PR review, QA pass, and deployment. What should take minutes takes days.
2. **Opacity** — compliance and product teams cannot inspect or audit the active rules without reading Java code.
3. **Fragility** — rules embedded in imperative code are easy to break when modifying adjacent business logic.

## 2. Objective

Build a minimal, working Policy Engine PoC that proves Drools 8.x can integrate cleanly with the existing Spring Boot 2.6 / Java 17 stack. The PoC must demonstrate:

- Declarative rule definition (DRL files) separate from application code
- Runtime rule evaluation via REST API
- Rule management through an admin dashboard (create, edit, toggle, test)
- Basic audit logging of every rule evaluation
- Hot-reloadable rules without application restart

**This is not a production system.** It is a proof of concept to validate the architecture, developer experience, and integration patterns before committing to a full implementation.

## 3. Success Criteria

| # | Criteria                                        | Measurement                                                  |
| - | ----------------------------------------------- | ------------------------------------------------------------ |
| 1 | Drools evaluates all 3 rule types correctly     | All unit + integration tests pass                            |
| 2 | Rules can be changed without redeployment       | Modify a threshold via admin UI → API returns updated result |
| 3 | Evaluation latency is acceptable                | < 50ms p95 for single rule evaluation (warm cache)           |
| 4 | Audit trail is complete                         | Every evaluation produces an audit record in PostgreSQL      |
| 5 | Team can run the PoC with one command            | `docker compose up` starts all services successfully         |
| 6 | Admin dashboard is functional                   | Can view, toggle, edit parameters, and write DRL rules       |

## 4. User Personas

### 4.1 Backend Developer

The primary consumer of the policy engine. Calls the evaluation API from other services (e.g., transaction service, financing service). Needs a clear API contract, predictable responses, and good error messages. May also write DRL rules for new policy types.

### 4.2 Operations / Admin

Manages day-to-day rule configuration: adjusting thresholds, enabling/disabling rules for specific scenarios, monitoring what rules are firing. Uses the admin dashboard exclusively — does not touch code.

### 4.3 Compliance Officer (Read-Only)

Needs to inspect active rules and review the audit trail. Requires visibility into what rules exist, what parameters they use, and a log of every evaluation decision. For the PoC, this persona only needs read access to the dashboard.

## 5. Functional Requirements

### 5.1 Policy Rule Types

The PoC implements three distinct rule types to demonstrate Drools' versatility across different policy patterns.

#### FR-01: Transaction Limit Policy

Evaluates whether a transaction is allowed based on the customer's account tier and daily cumulative amount.

**Input:**
- `accountTier` — SILVER, GOLD, or PLATINUM
- `transactionAmount` — the requested amount (IDR)
- `dailyCumulativeAmount` — total amount already transacted today (IDR)

**Rule logic (default thresholds):**

| Tier     | Daily Limit (IDR)  |
| -------- | ------------------ |
| SILVER   | 10,000,000         |
| GOLD     | 50,000,000         |
| PLATINUM | 200,000,000        |

**Output:**
- `allowed` — boolean
- `reason` — explanation string (e.g., "Daily limit exceeded for SILVER tier")
- `remainingLimit` — how much headroom remains

#### FR-02: Financing Eligibility Policy (Murabahah)

Determines whether a customer qualifies for Murabahah financing based on profile data.

**Input:**
- `age` — customer's age
- `monthlyIncome` — gross monthly income (IDR)
- `accountStatus` — ACTIVE, DORMANT, or CLOSED
- `requestedAmount` — financing amount requested (IDR)

**Rule logic (default criteria):**
- Age between 21 and 65 (inclusive)
- Monthly income ≥ 5,000,000 IDR
- Account status = ACTIVE
- Requested amount ≤ 10x monthly income (debt-to-income cap)

**Output:**
- `eligible` — boolean
- `reasons` — list of strings explaining pass/fail for each criterion
- `maxFinancingAmount` — calculated ceiling

#### FR-03: Risk Flag Policy

Flags transactions that match risk patterns for further review.

**Input:**
- `transactionAmount` — amount (IDR)
- `destinationRegion` — target region code
- `transactionFrequency` — number of transactions in the last hour
- `isNewBeneficiary` — boolean

**Rule logic (default thresholds):**
- Flag if amount > 100,000,000 IDR (high-value)
- Flag if destination region is in the high-risk list (configurable)
- Flag if frequency > 10 transactions/hour AND new beneficiary
- Multiple flags increase the risk score additively

**Output:**
- `flagged` — boolean
- `riskScore` — integer (0–100)
- `flags` — list of triggered flag descriptions

### 5.2 Admin Dashboard

#### FR-04: Rule Listing and Overview

Display all registered rules with their status (active/inactive), type, last modified date, and current parameter values. Support filtering and searching.

#### FR-05: Parameter-Based Rule Management

For each rule, provide a form-based UI to:
- Toggle the rule active/inactive
- Edit threshold parameters (e.g., change SILVER daily limit from 10M to 15M)
- Save changes that take effect immediately (cache invalidation + Drools session reload)

#### FR-06: DRL Code Editor

Provide a Monaco-based code editor for advanced users to:
- View and edit the raw DRL source of any rule
- Create new DRL rules from scratch
- Validate DRL syntax before saving (compile check)
- Deploy the updated DRL to the running engine

#### FR-07: Rule Testing (Dry Run)

From the dashboard, allow users to:
- Select a rule
- Input test data via a JSON form
- Execute the rule against the test data
- View the evaluation result without producing an audit record

#### FR-08: Audit Log Viewer

Display a paginated, filterable list of rule evaluation records showing:
- Timestamp
- Rule name and version
- Input data (JSON)
- Output/result (JSON)
- Evaluation duration (ms)
- Source (API call origin)

### 5.3 REST API

#### FR-09: Rule Evaluation Endpoint

`POST /api/v1/policies/{policyType}/evaluate`

Accepts input data, evaluates it against the specified policy's active rules, returns the result, and writes an audit record.

#### FR-10: Rule Management Endpoints

- `GET /api/v1/rules` — list all rules
- `GET /api/v1/rules/{id}` — get rule detail including DRL source
- `PUT /api/v1/rules/{id}` — update rule parameters or DRL
- `POST /api/v1/rules` — create a new rule
- `PATCH /api/v1/rules/{id}/status` — toggle active/inactive
- `POST /api/v1/rules/{id}/test` — dry-run evaluation (no audit)

#### FR-11: Audit Endpoints

- `GET /api/v1/audit` — paginated audit log (supports filtering by rule, date range, result)

### 5.4 Caching

#### FR-12: Rule Caching

Compiled Drools `KieSession` objects are cached using Spring Cache. Cache is invalidated when a rule is updated via the admin API. Cache hit/miss should be logged for observability.

### 5.5 Audit Logging

#### FR-13: Evaluation Audit Trail

Every rule evaluation (except dry-run tests) produces a record in the `policy_audit_log` table containing: timestamp, policy type, rule ID, rule version, input JSON, output JSON, evaluation duration, and caller identifier.

## 6. Non-Functional Requirements

| #     | Requirement            | Target                                                    |
| ----- | ---------------------- | --------------------------------------------------------- |
| NFR-1 | Evaluation latency     | < 50ms p95 for single rule evaluation (cached)            |
| NFR-2 | Startup time           | < 30 seconds for full Docker Compose stack                |
| NFR-3 | Availability           | N/A (PoC — single instance is fine)                       |
| NFR-4 | Data persistence       | PostgreSQL with Docker volume (survives container restart) |
| NFR-5 | Browser support        | Latest Chrome / Firefox (admin dashboard)                 |
| NFR-6 | API documentation      | Swagger/OpenAPI auto-generated                            |

## 7. Scope

### In Scope

- Three rule types (transaction limit, financing eligibility, risk flag)
- Spring Boot backend with Drools integration
- PostgreSQL for rule storage and audit
- Spring Cache for KieSession caching
- React Router V7 admin dashboard (framework mode)
- Docker Compose for local deployment
- Unit and integration tests
- Swagger/OpenAPI documentation

### Out of Scope

- Authentication and authorization (no login for PoC)
- Multi-tenancy
- Rule versioning with rollback
- High availability / clustering
- Performance load testing
- CI/CD pipeline
- Production deployment
- Monitoring/alerting infrastructure (Grafana, Prometheus)
- Integration with actual `be-hijra-bank` services

## 8. Risks and Mitigations

| Risk                                           | Impact | Mitigation                                                           |
| ---------------------------------------------- | ------ | -------------------------------------------------------------------- |
| Drools 8.x incompatibility with Spring Boot 2.6 | High   | Validate dependency tree early; pin compatible versions              |
| DRL hot-reload causes memory leaks             | Medium | Use proper KieContainer disposal; monitor heap in testing            |
| Monaco editor adds significant bundle size     | Low    | Lazy-load the editor component; only load when DRL tab is active     |
| Complex DRL rules cause slow evaluation        | Medium | Set evaluation timeout; the PoC rules are intentionally simple       |

## 9. Future Considerations (Post-PoC)

These items are explicitly out of scope but should be considered if the PoC is successful:

- Rule versioning with diff view and rollback capability
- Role-based access control for the admin dashboard
- Rule templates for non-technical users
- Event-driven evaluation (Kafka integration)
- Rule dependency graph visualization
- A/B testing of rule variants
- Integration with the bank's existing audit infrastructure

---

*End of PRD*
